---
title: "Dementia linear mixed model"
output: html_document
date: "2023-08-08"
---

```{r library}

library(nlme)
```


```{r check longitudinal outcome mmse}

data_plot<-data_long.1[order(data_long.1$followupyears), ]

mmse_plot<-data_plot%>%
   select("study","id","idpicc","followupyears","visityear","mmse")

mmse_plot<-mmse_plot%>%
  arrange(id,followupyears)


ggplot(data = mmse_plot, aes(x = followupyears, y = mmse,group=id))+
    geom_line()

#check the one with all zero MMSE in followup years

mmse_plot%>%
  filter(mmse==0)

#1666
#1677
#1300

mmse_plot%>%
  filter(idpicc==1666) # 0 0

mmse_plot%>%
  filter(idpicc==1677) # 19 18 10 0 0

mmse_plot%>%
  filter(idpicc==1300) # 29 28 26 25 16 13 0 0 0

ggplot(data = subset(mmse_plot,study=="CamPalGN"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()

ggplot(data = subset(mmse_plot,study=="ParkWest"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()

ggplot(data = subset(mmse_plot,study=="PICNICS"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()

ggplot(data = subset(mmse_plot,study=="NYPUM"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()

ggplot(data = subset(mmse_plot,study=="PINE"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()

```

```{r baseline model}

baseline.cox.1<-coxph(Surv(years,cens)~age10+sex+yearseducation+mdsupdrs3.10+hybl+hallucinationsindex+cognitiveindex+strata(study),data=data.baseline.1, x = TRUE,model = TRUE)

#summary(baseline.cox.1)
#basehaz(baseline.cox.1)

baseline.cox.2<-coxph(Surv(years,cens)~age10+sex+yearseducation+mdsupdrs3.10+hybl+hallucinationsindex+cognitiveindex+strata(study),data=data.baseline.2, x = TRUE,model = TRUE)

baseline.cox.3<-coxph(Surv(years,cens)~age10+sex+yearseducation+mdsupdrs3.10+hybl+hallucinationsindex+cognitiveindex+strata(study),data=data.baseline.3, x = TRUE,model = TRUE)

baseline.cox.4<-coxph(Surv(years,cens)~age10+sex+yearseducation+mdsupdrs3.10+hybl+hallucinationsindex+cognitiveindex+strata(study),data=data.baseline.4, x = TRUE,model = TRUE)

baseline.cox.5<-coxph(Surv(years,cens)~age10+sex+yearseducation+mdsupdrs3.10+hybl+hallucinationsindex+cognitiveindex+strata(study),data=data.baseline.5, x = TRUE,model = TRUE)

baseline.cox.6<-coxph(Surv(years,cens)~age10+sex+yearseducation+mdsupdrs3.10+hybl+hallucinationsindex+cognitiveindex+strata(study),data=data.baseline.6, x = TRUE,model = TRUE)

baseline.cox.7<-coxph(Surv(years,cens)~age10+sex+yearseducation+mdsupdrs3.10+hybl+hallucinationsindex+cognitiveindex+strata(study),data=data.baseline.7, x = TRUE,model = TRUE)

baseline.cox.8<-coxph(Surv(years,cens)~age10+sex+yearseducation+mdsupdrs3.10+hybl+hallucinationsindex+cognitiveindex+strata(study),data=data.baseline.8, x = TRUE,model = TRUE)

baseline.cox.9<-coxph(Surv(years,cens)~age10+sex+yearseducation+mdsupdrs3.10+hybl+hallucinationsindex+cognitiveindex+strata(study),data=data.baseline.9, x = TRUE,model = TRUE)
```


```{r chose linear mixed model}

#----test to see which one works------

#As years of education only missing 11, so the best model select from first imputation data set can view as general

lme.1<-lme(mmse~ agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.1) 

lme.2<-lme(mmse~ sex+agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.1)

lme.3<-lme(mmse~ study+agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.1)

lme.4<-lme(mmse~ study*agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.1)

lme.5<-lme(mmse~ agebl+study*yearseducation, random = ~ followupyears | idpicc, data=data_long.1)

AIC(lme.1) #19800.31
AIC(lme.2) #19794.74
AIC(lme.3) #19786.14
AIC(lme.4) #19802.95
AIC(lme.5) #19794.21

BIC(lme.1) #19844.08
BIC(lme.2) #19844.76
BIC(lme.3) #19854.9
BIC(lme.4) #19896.7
BIC(lme.5) #19887.97

#Choose lme.1


lme.1.1<-lme(mmse~ agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.1) 

lme.1.2<-lme(mmse~ agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.2) 

lme.1.3<-lme(mmse~ agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.3) 

lme.1.4<-lme(mmse~ agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.4) 

lme.1.5<-lme(mmse~ agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.5) 

lme.1.6<-lme(mmse~ agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.6) 

lme.1.7<-lme(mmse~ agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.7) 

lme.1.8<-lme(mmse~ agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.8) 

lme.1.9<-lme(mmse~ agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.9) 

```

```{r joint model}

jointFit.1<-jm(baseline.cox.1, lme.1.1, time_var = "followupyears") #it works

summary(jointFit)

jointFit.2<-jm(baseline.cox.2, lme.1.2, time_var = "followupyears") 

jointFit.3<-jm(baseline.cox.3, lme.1.3, time_var = "followupyears") 

jointFit.4<-jm(baseline.cox.4, lme.1.4, time_var = "followupyears") 

jointFit.5<-jm(baseline.cox.5, lme.1.5, time_var = "followupyears") 

jointFit.6<-jm(baseline.cox.6, lme.1.6, time_var = "followupyears") 

jointFit.7<-jm(baseline.cox.7, lme.1.7, time_var = "followupyears")

jointFit.8<-jm(baseline.cox.8, lme.1.8, time_var = "followupyears") 

jointFit.9<-jm(baseline.cox.9, lme.1.9, time_var = "followupyears") 



```


```{r }

# Loop through each study to extract and plot baseline hazard
for (study_id in study_names) {
  study_data <- subset(data.baseline.1, study == study_id)
  cox_model <- coxph(Surv(years, cens) ~ age10 + sex + mdsupdrs3.10 + hybl + hallucinationsindex + cognitiveindex, data = study_data, x = TRUE, model = TRUE)
  baseline_hazard <- basehaz(cox_model)
  baseline_hazard$hazard <- diff(c(0, baseline_hazard$hazard)) / diff(c(0, baseline_hazard$time))
  
  # Plot the baseline hazard for the current study
  plot(baseline_hazard$time, baseline_hazard$hazard, type = "s", xlab = "Time", ylab = "Hazard", main = paste("Baseline Hazard - Study", study_id))
}



```

```{r Note for next step}

# Need to find a Linear mixed model to fit MMSE

#Re run the imputation, to see if the cogntive index is yes and no will that be better?

#Need to think about how to do the rubin's rule.

```