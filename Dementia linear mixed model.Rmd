---
title: "Dementia linear mixed model"
output: html_document
date: "2023-08-08"
---

```{r library}

library(nlme)
#library(grid)
#library(gridExtra)
library(patchwork)#arrange plot
```


```{r randomly select the second imputation}

#Need to remove the MMSE records after event (dementia)

data_long.2.new<-data_long.2%>%
                 filter(years>followupyears)

#Because PINE had biggest sample size, so the PINE should be as reference group

```


```{r check longitudinal outcome mmse}

data_plot<-data_long.2.new[order(data_long.2.new$followupyears), ]

mmse_plot<-data_plot%>%
   select("study","id","idpicc","followupyears","visityear","mmse")%>%
   filter(followupyears!=0)

mmse_plot<-mmse_plot%>%
  arrange(id,followupyears)


#ggplot(data = mmse_plot, aes(x = followupyears, y = mmse,group=id))+
#    geom_line()

#check the one with all zero MMSE in followup years


p1<-ggplot(data = subset(mmse_plot,study=="CamPalGN"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()+
    xlab("follow-up years (CamPalGN)")+
    ylab("MMSE")+
    theme_bw()

p2<-ggplot(data = subset(mmse_plot,study=="ParkWest"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()+
    xlab("follow-up years (ParkWest)")+
    ylab("MMSE")+
    theme_bw()

p3<-ggplot(data = subset(mmse_plot,study=="PICNICS"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()+
    xlab("follow-up years (PICNICS)")+
    ylab("MMSE")+
    theme_bw()

p4<-ggplot(data = subset(mmse_plot,study=="NYPUM"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()+
    xlab("follow-up years (NYPUM)")+
    ylab("MMSE")+
    theme_bw()

p5<-ggplot(data = subset(mmse_plot,study=="PINE"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()+
    xlab("follow-up years (PINE)")+
    ylab("MMSE")+
    theme_bw()

p6<-ggplot(data = mmse_plot, aes(x = followupyears, y = mmse,group=id))+
    geom_line()+
    xlab("follow-up years (PICC)")+
    ylab("MMSE")+
    theme_bw()

#png("MMSE1.png",width = 3000,height =1500,res = 400)

p1+p2+p3+p4+p5+p6

#grid.arrange(p1,p2,p3,p4,ncol=2) not need 

#dev.off()

#A<-mmse_plot%>%
#  filter(study=="PICNICS")%>%
#  filter(mmse<20)

#8 lower than 20 in PICNICS

#length(unique(A$idpicc))

```


```{r Create the fitting model dataset}

#-----remove variables that don't need----

data_long.2.fit<-data_long.2.new%>%
  select(study,idpicc,agebl,sex,yearseducation,followupyears,mmse,mdsupdrspart3bltotalconvertedasa,hybl,hallucinationsindex,cognitiveindex,years,cens)

data.baseline.2.fit<-data.baseline.2%>%
  select(study,idpicc,agebl,sex,yearseducation,mdsupdrspart3bltotalconvertedasa,hybl,hallucinationsindex,cognitiveindex,years,cens)


#check the study levels

levels(data_long.2.fit$study)
levels(data.baseline.2.fit$study)

#----changing the reference level to PINE, as the PINE has the biggest sample size of patients with event

data.baseline.2.fit$study<-factor(data.baseline.2.fit$study,levels=c("PINE","CamPalGN","NYPUM","ParkWest","PICNICS")) #put PINE as the first level

levels(data.baseline.2.fit$study)

data.baseline.2.fit%>%
  group_by(study)%>%
  count(cens)


data_long.2.fit$study<-factor(data_long.2.fit$study,levels=c("PINE","CamPalGN","NYPUM","ParkWest","PICNICS")) #put PINE as the first level

levels(data_long.2.fit$study)


```



```{r create the lme data and fit model}

#setdiff(unique(data.baseline.2$id),unique(data_long.2.new$id))

length(unique(data_long.2.new$idpicc))
nrow(data.baseline.2)

#----test to see which one works------

#As years of education only missing 11, so the best model select from first imputation data set can view as general

lme.1<-lme(mmse~ agebl+yearseducation, random = ~ followupyears | idpicc, data=data_long.2.fit) 

lme.2<-lme(mmse~ agebl+sex+yearseducation, random = ~ followupyears | idpicc, data=data_long.2.fit)

lme.3<-lme(mmse~ study+agebl+sex+yearseducation, random = ~ followupyears | idpicc, data=data_long.2.fit)

lme.4<-lme(mmse~ study*agebl+sex+yearseducation, random = ~ followupyears | idpicc, data=data_long.2.fit)

lme.5<-lme(mmse~ agebl+sex+study*yearseducation, random = ~ followupyears | idpicc, data=data_long.2.fit)

lme.6<-lme(mmse~ agebl+sex*study+yearseducation, random = ~ followupyears | idpicc, data=data_long.2.fit)

#summary(lme.3)

#put PINE as the ref

round(AIC(lme.1),2) 
AIC(lme.2) 
AIC(lme.3) 
AIC(lme.4) 
AIC(lme.5) 
AIC(lme.6)

BIC(lme.1) 
BIC(lme.2)
BIC(lme.3) 
BIC(lme.4) 
BIC(lme.5) 
BIC(lme.6)

#choose lme.3

#variables in lme: sex agebl yearseducation followupyears idpicc
#variables in Cox: agebl sex yearseducation mdsupdrspart3bltotalconvertedasa hybl hallucinationsindex cognitiveindex strata(study)
```

```{r joint model}
#----joint model---

lme<-lme(mmse~ study+agebl+sex+yearseducation, random = ~ followupyears | idpicc, data=data_long.2.fit)

#Stratified Cox

baseline.cox.1<-coxph(Surv(years,cens)~agebl+sex+yearseducation+mdsupdrspart3bltotalconvertedasa+hybl+hallucinationsindex+cognitiveindex+strata(study),data=data.baseline.2.fit, x = TRUE,model = TRUE)

#Study as fixed effect

baseline.cox.2<-coxph(Surv(years,cens)~agebl+sex+yearseducation+mdsupdrspart3bltotalconvertedasa+hybl+hallucinationsindex+cognitiveindex+study,data=data.baseline.2.fit, x = TRUE,model = TRUE)

#Try to see if the Cox need to have slope or area

#jointFit.1<-jm(baseline.cox.1, lme, time_var = "followupyears") 

#summary(jointFit.1)

jointFit.2<-jm(baseline.cox.2, lme, time_var = "followupyears") 

summary(jointFit.2)

#compare_jm(jointFit.1,jointFit.2)

#Chose jointFit.1


```
```{r predict}

#randomly select patient as example to illustrate

predict.data<-data_long.2.fit[data_long.2.fit$idpicc == 1131,]  #event year is 6

#----Only baseline information-----

predict.data.time.0<-predict.data[predict.data$followupyears==0,] 

predict.data.time.0$cens<-0 #not event

predict.data.time.0$years<-0 #predict time at 0 years

predMMSE.0<-predict(jointFit.2,newdata = predict.data.time.0,times = seq(0,3, length.out=20),return_newdata = T) #for future time point

predSurv.0<-predict(jointFit.2,newdata = predict.data.time.0,process = "event",times = seq(0,3, length.out=20),return_newdata = T) # use the information before 3 years to predict


plot(predMMSE.0,predSurv.0)


#-----From baseline up to 1 year-----

predict.data.time.1<-predict.data[predict.data$followupyears<2,] 

predict.data.time.1$cens<-0 #not event

predict.data.time.1$years<-1.2 #predict time at 0 years

predMMSE.1<-predict(jointFit.2,newdata = predict.data.time.1,times = seq(1.2,4, length.out=20),return_newdata = T) #for future time point

predSurv.1<-predict(jointFit.2,newdata = predict.data.time.1,process = "event",times = seq(1.2,4, length.out=20),return_newdata = T) # use the information before 3 years to predict


plot(predMMSE.1,predSurv.1)


#-----From baseline up to 2 year-----

predict.data.time.2<-predict.data[predict.data$followupyears<3,] 

predict.data.time.2$cens<-0 #not event

predict.data.time.2$years<-2.1 #predict time at 0 years

predMMSE.2<-predict(jointFit.2,newdata = predict.data.time.2,times = seq(2.1,5, length.out=20),return_newdata = T) #for future time point

predSurv.2<-predict(jointFit.2,newdata = predict.data.time.2,process = "event",times = seq(2.1,5, length.out=20),return_newdata = T) # use the information before 3 years to predict


plot(predMMSE.2,predSurv.2)



#------From baseline up to 3 years-----

predict.data.time.3<-predict.data[predict.data$followupyears<4,] 

predict.data.time.3$cens<-0 #not event

predict.data.time.3$years<-3.1 #predict time at 0 years

#predict for longitudinal outcomes

predMMSE.3<-predict(jointFit.2,newdata = predict.data.time.3,times = seq(3.1,6, length.out=20),return_newdata = T) #for future time point

predSurv.3<-predict(jointFit.2,newdata = predict.data.time.3,process = "event",times = seq(3.1,6, length.out=20),return_newdata = T) # use the information before 3 years to predict

plot(predMMSE.3,predSurv.3)


#------From baseline up to 4 years-----

predict.data.time.4<-predict.data[predict.data$followupyears<5,] 

predict.data.time.4$cens<-0 #not event

predict.data.time.4$years<-4 #predict time at 0 years

#predict for longitudinal outcomes

predMMSE.4<-predict(jointFit.2,newdata = predict.data.time.4,times = seq(4,7, length.out=20),return_newdata = T) #for future time point

predSurv.4<-predict(jointFit.2,newdata = predict.data.time.4,process = "event",times = seq(4,7, length.out=20),return_newdata = T) # use the information before 3 years to predict

plot(predMMSE.4,predSurv.4)


#------From baseline up to 5 years-----

predict.data.time.5<-predict.data[predict.data$followupyears<6,] 

predict.data.time.5$cens<-0 #not event

predict.data.time.5$years<-5.04 #predict time at 0 years

#predict for longitudinal outcomes

predMMSE.5<-predict(jointFit.2,newdata = predict.data.time.5,times = seq(5.04,8, length.out=20),return_newdata = T) #for future time point

predSurv.5<-predict(jointFit.2,newdata = predict.data.time.5,process = "event",times = seq(5.04,8, length.out=20),return_newdata = T) # use the information before 3 years to predict

plot(predMMSE.5,predSurv.5)


#----Arrange plot----

#png("JMpred1.png",width = 4000,height =1500,res = 400)

#par(mfrow=c(1,3))

plot(predMMSE.0,predSurv.0,ylab_long = "MMSE",ylab_event = "Cumulative risk of dementia",xlab = "Follow-up years",cex_ylab_long = 1.5,cex_axis = 1.2,cex_xlab = 1.5)
plot(predMMSE.1,predSurv.1,ylab_long = "MMSE",ylab_event = "Cumulative risk of dementia",xlab = "Follow-up years",cex_ylab_long = 1.5,cex_axis = 1.2,cex_xlab = 1.5)
plot(predMMSE.2,predSurv.2,ylab_long = "MMSE",ylab_event = "Cumulative risk of dementia",xlab = "Follow-up years",cex_ylab_long = 1.5,cex_axis = 1.2,cex_xlab = 1.5)

#dev.off()

#png("JMpred2.png",width = 4000,height =1500,res = 400)

#par(mfrow=c(1,3))

plot(predMMSE.3,predSurv.3,ylab_long = "MMSE",ylab_event = "Cumulative risk of dementia",xlab = "Follow-up years",cex_ylab_long = 1.5,cex_axis = 1.2,cex_xlab = 1.5)
plot(predMMSE.4,predSurv.4,ylab_long = "MMSE",ylab_event = "Cumulative risk of dementia",xlab = "Follow-up years",cex_ylab_long = 1.5,cex_axis = 1.2,cex_xlab = 1.5)
plot(predMMSE.5,predSurv.5,ylab_long = "MMSE",ylab_event = "Cumulative risk of dementia",xlab = "Follow-up years",cex_ylab_long = 1.5,cex_axis = 1.2,cex_xlab = 1.5)

#dev.off()
```
```{r pre IECV}

data_long.2$age10<-data_long.2$agebl/10

data_long.2$mdsupdrs3.10<-data_long.2$mdsupdrspart3bltotalconvertedasa/10

Cam_long<-data_long.2%>%
  filter(study!="CamPalGN")

Cam.baseline<-data.baseline.2%>%
  filter(study!="CamPalGN")

Cam.v<-data_long.2%>%
  filter(study=="CamPalGN")



#refit model

Cam.cox<-coxph(Surv(years,cens)~age10+sex+yearseducation+mdsupdrs3.10+hybl+hallucinationsindex+cognitiveindex+strata(study),data=Cam.baseline, x = TRUE,model = TRUE)

Cam.lme<-lme(mmse~ sex+agebl+yearseducation, random = ~ followupyears | idpicc, data=Cam_long) 

jointFit.Cam<-jm(Cam.cox, Cam.lme, time_var = "followupyears") 

summary(jointFit.Cam)

tvAUC(jointFit.Cam,Cam.v,Tstart = 3, Dt=1)

```


