---
title: "update linear mixed (Dementia)"
output: html_document
date: "2023-11-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
library(dplyr)
library(tidyr)
library(Hmisc)
library(finalfit)
library(jomo)
library(mice)
library(mitools)
library(rms)
library(mitml)
library(survminer)
library(patchwork) #Arrange plot
library(ggplot2)
library(GGally)
library(gridExtra)
library(png)
library(grid)
library(haven) #read_dta
library(nlme)
library(JMbayes2)
```

```{r data}
#data<-read_dta("PICC dynamic prediction v4.dta")

#write.csv(data,"data.csv",row.names = F)  # need to be csv file, otherwise it fails
datanew<-read.csv("data.csv")  #import data again

#Update data: PCP66 is a male, baseline age is 74.8

datanew$sex[datanew$originalid=="PCP66"]<-0  #male is 0
datanew$agebl[datanew$originalid=="PCP66"]<-74.8

#update P150 H&Y year2 is 2 not 0
#update P757 H&Y year1 is 1.5 not 0

datanew$hyyr2[datanew$originalid=="P150"]<-2
datanew$hyyr1[datanew$originalid=="P757"]<-1.5

#UPDATE P195 need to be exclude cos patient decline the follow-up and without the visit date only mmse value in medical record

datanew<-datanew %>%
  filter(originalid!="P195")

datanew[datanew$originalid=="PCP46",]

```


```{r pre data}

#---Adding cognitive symptom and hallucination in longtindinal data----

data1.up<-datanew%>%
  select("study","idpicc","originalid","incidencecase","agebl","sex","hybl",
         "smoking",
         "mdsupdrspart3bltotalconvertedasa", "yearseducation",
         "mmsebltotal","mmseyr1total","mmseyr2total","mmseyr3total","mmseyr4total","mmseyr4total","mmseyr5total","mmseyr6total","mmseyr7total","mmseyr8total","mmseyr9total","mmseyr10total","mmseyr11total","mmseyr11total","mmseyr12total","datevisitbl","datevisityr1","datevisityr2","datevisityr3","datevisityr4","datevisityr5","datevisityr6","datevisityr7","datevisityr8","datevisityr9","datevisityr10","datevisityr11","datevisityr12","datevisityr13","datevisityr14","datevisityr15","datelastseen","datelastknownalive","datedeath","datedementia","datelost","losttofollowup","dead",
         "mdsupdrsbl101cognitive","mdsupdrsyr1101cognitive","mdsupdrsyr2101cognitive","mdsupdrsyr3101cognitive","mdsupdrsyr4101cognitive","mdsupdrsyr5101cognitive","mdsupdrsyr6101cognitive","mdsupdrsyr7101cognitive","mdsupdrsyr8101cognitive","mdsupdrsyr9101cognitive","mdsupdrsyr10101cognitive","mdsupdrsyr11101cognitive",
         "updrsblitem1intellectual","updrsyr1item1intellectual","updrsyr2item1intellectual","updrsyr3item1intellectual","updrsyr4item1intellectual","updrsyr5item1intellectual","updrsyr6item1intellectual","updrsyr7item1intellectual","updrsyr8item1intellectual","updrsyr9item1intellectual","updrsyr10item1intellectual","updrsyr11item1intellectual",
         "mdsupdrsbl102hallucinations","mdsupdrsyr1102hallucinations","mdsupdrsyr2102hallucinations","mdsupdrsyr3102hallucinations","mdsupdrsyr4102hallucinations","mdsupdrsyr5102hallucinations","mdsupdrsyr6102hallucinations","mdsupdrsyr7102hallucinations","mdsupdrsyr8102hallucinations","mdsupdrsyr9102hallucinations","mdsupdrsyr10102hallucinations","mdsupdrsyr11102hallucinations",
         "updrsblitem2thoughtdisorders","updrsyr1item2thoughtdisorders","updrsyr2item2thoughtdisorders","updrsyr3item2thoughtdisorders","updrsyr4item2thoughtdisorders","updrsyr5item2thoughtdisorders","updrsyr6item2thoughtdisorders","updrsyr7item2thoughtdisorders","updrsyr8item2thoughtdisorders","updrsyr9item2thoughtdisorders","updrsyr10item2thoughtdisorders","updrsyr11item2thoughtdisorders")

data1.up$study<-factor(data1.up$study,
                    levels = c(1,2,3,4,5,6),
                    labels= c("CamPalGN","ICICLE","NYPUM","ParkWest","PICNICS","PINE"))
#remove ICICLE

data1.up<-data1.up%>%
  filter(study!="ICICLE")

data1.up$study<-droplevels(data1.up$study)

#----change into factor---

data1.up$sex<-factor(data1.up$sex,
                    levels = c(0,1),
                    labels= c("male","female"))


#UPDATE PCP46 and PCP66 both male

data1.up[data1.up$originalid=="PCP46",]$sex<-"male"
data1.up[data1.up$originalid=="PCP46",]$idpicc<-1692
data1.up[data1.up$originalid=="PCP66",]$sex<-"male"
data1.up[data1.up$originalid=="PCP66",]$idpicc<-1693


data1.up$smoking<-ifelse(data1.up$smoking<3,
                      1,2) #then 1 and 2 will be 1, 3 will be 2

data1.up$smoking<-factor(data1.up$smoking,
                      levels = c(1,2),
                      labels = c("yes","no"))


#------Create index for cognitive (yes/no)-------

#Cognitive symptoms as measured by UPDRS item 1 (intellectual impairment)/MDS-UPDRS item 1 (cognitive impairment), categorized as 0-1 (no cognitive symptoms), >1 (cognitive symptoms)

#Baseline

data1.up$mdsupdrsbl101cognitive[data1.up$mdsupdrsbl101cognitive>1]<-1     
data1.up$updrsblitem1intellectual[data1.up$updrsblitem1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitivebl=mdsupdrsbl101cognitive)%>%           
      mutate(cognitivebl=coalesce(cognitivebl,updrsblitem1intellectual))  # 0=no,1=yes

data1.up$cognitivebl<-factor(data1.up$cognitivebl,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))
#year 1

data1.up$mdsupdrsyr1101cognitive[data1.up$mdsupdrsyr1101cognitive>1]<-1     
data1.up$updrsyr1item1intellectual[data1.up$updrsyr1item1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitiveyr1=mdsupdrsyr1101cognitive)%>%           
      mutate(cognitiveyr1=coalesce(cognitiveyr1,updrsyr1item1intellectual))  # 0=no,1=yes

data1.up$cognitiveyr1<-factor(data1.up$cognitiveyr1,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#year 2

data1.up$mdsupdrsyr2101cognitive[data1.up$mdsupdrsyr2101cognitive>1]<-1     
data1.up$updrsyr2item1intellectual[data1.up$updrsyr2item1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitiveyr2=mdsupdrsyr2101cognitive)%>%           
      mutate(cognitiveyr2=coalesce(cognitiveyr2,updrsyr2item1intellectual))  # 0=no,1=yes

data1.up$cognitiveyr2<-factor(data1.up$cognitiveyr2,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))


#year 3

data1.up$mdsupdrsyr3101cognitive[data1.up$mdsupdrsyr3101cognitive>1]<-1     
data1.up$updrsyr3item1intellectual[data1.up$updrsyr3item1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitiveyr3=mdsupdrsyr3101cognitive)%>%           
      mutate(cognitiveyr3=coalesce(cognitiveyr3,updrsyr3item1intellectual))  # 0=no,1=yes

data1.up$cognitiveyr3<-factor(data1.up$cognitiveyr3,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#year 4

data1.up$mdsupdrsyr4101cognitive[data1.up$mdsupdrsyr4101cognitive>1]<-1     
data1.up$updrsyr4item1intellectual[data1.up$updrsyr4item1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitiveyr4=mdsupdrsyr4101cognitive)%>%           
      mutate(cognitiveyr4=coalesce(cognitiveyr4,updrsyr4item1intellectual))  # 0=no,1=yes

data1.up$cognitiveyr4<-factor(data1.up$cognitiveyr4,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))


#year 5

data1.up$mdsupdrsyr5101cognitive[data1.up$mdsupdrsyr5101cognitive>1]<-1     
data1.up$updrsyr5item1intellectual[data1.up$updrsyr5item1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitiveyr5=mdsupdrsyr5101cognitive)%>%           
      mutate(cognitiveyr5=coalesce(cognitiveyr5,updrsyr5item1intellectual))  # 0=no,1=yes

data1.up$cognitiveyr5<-factor(data1.up$cognitiveyr5,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#year 6

data1.up$mdsupdrsyr6101cognitive[data1.up$mdsupdrsyr6101cognitive>1]<-1     
data1.up$updrsyr6item1intellectual[data1.up$updrsyr6item1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitiveyr6=mdsupdrsyr6101cognitive)%>%           
      mutate(cognitiveyr6=coalesce(cognitiveyr6,updrsyr6item1intellectual))  # 0=no,1=yes

data1.up$cognitiveyr6<-factor(data1.up$cognitiveyr6,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#year 7

data1.up$mdsupdrsyr7101cognitive[data1.up$mdsupdrsyr7101cognitive>1]<-1     
data1.up$updrsyr7item1intellectual[data1.up$updrsyr7item1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitiveyr7=mdsupdrsyr7101cognitive)%>%           
      mutate(cognitiveyr7=coalesce(cognitiveyr7,updrsyr7item1intellectual))  # 0=no,1=yes

data1.up$cognitiveyr7<-factor(data1.up$cognitiveyr7,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#year 8

data1.up$mdsupdrsyr8101cognitive[data1.up$mdsupdrsyr8101cognitive>1]<-1     
data1.up$updrsyr8item1intellectual[data1.up$updrsyr8item1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitiveyr8=mdsupdrsyr8101cognitive)%>%           
      mutate(cognitiveyr8=coalesce(cognitiveyr8,updrsyr8item1intellectual))  # 0=no,1=yes

data1.up$cognitiveyr8<-factor(data1.up$cognitiveyr8,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#year 9

data1.up$mdsupdrsyr9101cognitive[data1.up$mdsupdrsyr9101cognitive>1]<-1     
data1.up$updrsyr9item1intellectual[data1.up$updrsyr9item1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitiveyr9=mdsupdrsyr9101cognitive)%>%           
      mutate(cognitiveyr9=coalesce(cognitiveyr9,updrsyr9item1intellectual))  # 0=no,1=yes

data1.up$cognitiveyr9<-factor(data1.up$cognitiveyr9,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#year 10

data1.up$mdsupdrsyr10101cognitive[data1.up$mdsupdrsyr10101cognitive>1]<-1     
data1.up$updrsyr10item1intellectual[data1.up$updrsyr10item1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitiveyr10=mdsupdrsyr10101cognitive)%>%           
      mutate(cognitiveyr10=coalesce(cognitiveyr10,updrsyr10item1intellectual))  # 0=no,1=yes

data1.up$cognitiveyr10<-factor(data1.up$cognitiveyr10,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#year 11

data1.up$mdsupdrsyr11101cognitive[data1.up$mdsupdrsyr11101cognitive>1]<-1     
data1.up$updrsyr11item1intellectual[data1.up$updrsyr11item1intellectual>1]<-1

data1.up<-data1.up %>%
      mutate(cognitiveyr11=mdsupdrsyr11101cognitive)%>%           
      mutate(cognitiveyr11=coalesce(cognitiveyr11,updrsyr11item1intellectual))  # 0=no,1=yes

data1.up$cognitiveyr11<-factor(data1.up$cognitiveyr11,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))



table(data1.up$cognitivebl,data1.up$study)
table(data1.up$cognitiveyr1,data1.up$study)
table(data1.up$cognitiveyr2,data1.up$study)
table(data1.up$cognitiveyr3,data1.up$study)
table(data1.up$cognitiveyr4,data1.up$study)
table(data1.up$cognitiveyr5,data1.up$study)
table(data1.up$cognitiveyr6,data1.up$study)
table(data1.up$cognitiveyr7,data1.up$study)
table(data1.up$cognitiveyr8,data1.up$study)
table(data1.up$cognitiveyr9,data1.up$study)
table(data1.up$cognitiveyr10,data1.up$study)
table(data1.up$cognitiveyr11,data1.up$study)


#------Create index for hallucinations------

#Baseline

data1.up$updrshallucinationsbl<-ifelse(data1.up$mdsupdrsbl102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersbl<-ifelse(data1.up$updrsblitem2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsbl=updrshallucinationsbl)%>%           
      mutate(hallucinationsbl=coalesce(hallucinationsbl,updrsthoughtdisordersbl)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsbl<-factor(data1.up$hallucinationsbl,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#Year 1

data1.up$updrshallucinationsyr1<-ifelse(data1.up$mdsupdrsyr1102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersyr1<-ifelse(data1.up$updrsyr1item2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsyr1=updrshallucinationsyr1)%>%           
      mutate(hallucinationsyr1=coalesce(hallucinationsyr1,updrsthoughtdisordersyr1)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsyr1<-factor(data1.up$hallucinationsyr1,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#Year 2

data1.up$updrshallucinationsyr2<-ifelse(data1.up$mdsupdrsyr2102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersyr2<-ifelse(data1.up$updrsyr2item2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsyr2=updrshallucinationsyr2)%>%           
      mutate(hallucinationsyr2=coalesce(hallucinationsyr2,updrsthoughtdisordersyr2)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsyr2<-factor(data1.up$hallucinationsyr2,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))


#Year 3

data1.up$updrshallucinationsyr3<-ifelse(data1.up$mdsupdrsyr3102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersyr3<-ifelse(data1.up$updrsyr3item2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsyr3=updrshallucinationsyr3)%>%           
      mutate(hallucinationsyr3=coalesce(hallucinationsyr3,updrsthoughtdisordersyr3)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsyr3<-factor(data1.up$hallucinationsyr3,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))


#Year 4

data1.up$updrshallucinationsyr4<-ifelse(data1.up$mdsupdrsyr4102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersyr4<-ifelse(data1.up$updrsyr4item2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsyr4=updrshallucinationsyr4)%>%           
      mutate(hallucinationsyr4=coalesce(hallucinationsyr4,updrsthoughtdisordersyr4)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsyr4<-factor(data1.up$hallucinationsyr4,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#Year 5

data1.up$updrshallucinationsyr5<-ifelse(data1.up$mdsupdrsyr5102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersyr5<-ifelse(data1.up$updrsyr5item2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsyr5=updrshallucinationsyr5)%>%           
      mutate(hallucinationsyr5=coalesce(hallucinationsyr5,updrsthoughtdisordersyr5)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsyr5<-factor(data1.up$hallucinationsyr5,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#Year 6

data1.up$updrshallucinationsyr6<-ifelse(data1.up$mdsupdrsyr6102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersyr6<-ifelse(data1.up$updrsyr6item2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsyr6=updrshallucinationsyr6)%>%           
      mutate(hallucinationsyr6=coalesce(hallucinationsyr6,updrsthoughtdisordersyr6)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsyr6<-factor(data1.up$hallucinationsyr6,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#Year 7

data1.up$updrshallucinationsyr7<-ifelse(data1.up$mdsupdrsyr7102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersyr7<-ifelse(data1.up$updrsyr7item2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsyr7=updrshallucinationsyr7)%>%           
      mutate(hallucinationsyr7=coalesce(hallucinationsyr7,updrsthoughtdisordersyr7)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsyr7<-factor(data1.up$hallucinationsyr7,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#Year 8

data1.up$updrshallucinationsyr8<-ifelse(data1.up$mdsupdrsyr8102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersyr8<-ifelse(data1.up$updrsyr8item2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsyr8=updrshallucinationsyr8)%>%           
      mutate(hallucinationsyr8=coalesce(hallucinationsyr8,updrsthoughtdisordersyr8)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsyr8<-factor(data1.up$hallucinationsyr8,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#Year 9

data1.up$updrshallucinationsyr9<-ifelse(data1.up$mdsupdrsyr9102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersyr9<-ifelse(data1.up$updrsyr9item2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsyr9=updrshallucinationsyr9)%>%           
      mutate(hallucinationsyr9=coalesce(hallucinationsyr9,updrsthoughtdisordersyr9)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsyr9<-factor(data1.up$hallucinationsyr9,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

#Year 10

data1.up$updrshallucinationsyr10<-ifelse(data1.up$mdsupdrsyr10102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersyr10<-ifelse(data1.up$updrsyr10item2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsyr10=updrshallucinationsyr10)%>%           
      mutate(hallucinationsyr10=coalesce(hallucinationsyr10,updrsthoughtdisordersyr10)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsyr10<-factor(data1.up$hallucinationsyr10,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))


#Year 11

data1.up$updrshallucinationsyr11<-ifelse(data1.up$mdsupdrsyr11102hallucinations>0,1,0)  # 1=yes,0=no

data1.up$updrsthoughtdisordersyr11<-ifelse(data1.up$updrsyr11item2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1.up<-data1.up %>%
      mutate(hallucinationsyr11=updrshallucinationsyr11)%>%           
      mutate(hallucinationsyr11=coalesce(hallucinationsyr11,updrsthoughtdisordersyr11)) #if updrshallucinations not find then use updrsthoughtdisorders

data1.up$hallucinationsyr11<-factor(data1.up$hallucinationsyr11,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))

table(data1.up$hallucinationsbl,data1.up$study)
table(data1.up$hallucinationsyr1,data1.up$study)
table(data1.up$hallucinationsyr2,data1.up$study)
table(data1.up$hallucinationsyr3,data1.up$study)
table(data1.up$hallucinationsyr4,data1.up$study)
table(data1.up$hallucinationsyr5,data1.up$study)
table(data1.up$hallucinationsyr6,data1.up$study)
table(data1.up$hallucinationsyr7,data1.up$study)
table(data1.up$hallucinationsyr8,data1.up$study)
table(data1.up$hallucinationsyr9,data1.up$study)
table(data1.up$hallucinationsyr10,data1.up$study)
table(data1.up$hallucinationsyr11,data1.up$study)

```


```{r cens events}

#-----create events/censoring years------

data1.up<-data1.up %>%
  mutate(t=datedementia)%>%           
  mutate(t=coalesce(t,datelastknownalive))%>%
  mutate(t=coalesce(t,datelastseen))

#if patients have the date of dementia then t is the date of dementia. If patients without date of dementia, then the censoring date will be the date of last know alive. If patients without the date of last know alive then the censoring date will be the date last seen. Because I found some patients with date of lost is much later than the last seen, but the measurement stop in the last seen visiting year.

data1.up$cens<-ifelse(is.na(data1.up$datedementia),0,1)  #0=right censored, 1=event 

data1.up$tt<-as.Date(as.character(data1.up$t), format="%Y-%m-%d")-
                as.Date(as.character(data1.up$datevisitbl), format="%Y-%m-%d")

data1.up$tt<-as.numeric(data1.up$tt)

data1.up$years<-data1.up$tt/365.25  #1222 rows

#Details of the reason of removing can be found in Dementia pre1.Rmd (the data only MMSE longtidinal)

data1.up<-data1.up%>%
  filter(data1.up$years>0) 

data1.up%>%
  group_by(study)%>%
  count()

data1.up%>%
  group_by(study)%>%
  summarise(sum(cens))

#----up to 10 years----

data1.temp10.up<-survSplit(Surv(years, cens) ~ ., data = data1.up, cut = 10,
                  episode="timegroup")


data1.10.up<-subset(data1.temp10.up, timegroup == 1) #only the first 10 year

```


```{r check missing data}
#impute data first before it change to longitudinal data

data.rename.up<-data1.10.up%>%  #rember to change to data1.10.remove
  rename("Age at baseline"=agebl, 
         "Sex"=sex,
         "MDS-UPDRS part3"=mdsupdrspart3bltotalconvertedasa,"Hoehn and Yahr Scale"=hybl, "Smoking"=smoking,
         "Years of education"=yearseducation
         ) #

explanatory<-c("Smoking","Years of education","MDS-UPDRS part3","Hoehn and Yahr Scale") 
dependent<- c("cens","tt") #"Smoking"

#png("missing.up.png",width = 3000,height =2000,res = 400)

mispattern.up<-data.rename.up %>% 
  missing_pattern(explanatory)

#dev.off()

#---check how many missing at least one---

colnames(data1.10.up[,c(8,9,10)])

nrow(data1.10.up[complete.cases(data1.10.up[,c(8,9,10)]),])  #854 in data1.10

(882-854)/882 #0.03

#Only 28 patient with missing value

#See how many patient with event have missing data

data1.10.up%>%
  filter(is.na(smoking))%>%
  count(cens)

#All missing mdsupdrs without event
#4 missing years of education had event
#3 missing smoking had event

#-----Impute missing data-----

#We impute the missing value with the impuation value of the second impuation dataset as in the previous analysis 
#Need to run the imputation first

data1.10.up%>%
  filter(is.na(smoking))

#Missing MDS-UPDRS idpicc 633 726 759 822 830 831 1246

#imp3.new%>%
#  filter(Imputation==2)%>%
#  filter(idpicc==1246)%>%
#  select(mdsupdrspart3bltotalconvertedasa)

data1.10.up[data1.10.up$idpicc==633,]$mdsupdrspart3bltotalconvertedasa<-9.177631	
data1.10.up[data1.10.up$idpicc==726,]$mdsupdrspart3bltotalconvertedasa<-18.94427
data1.10.up[data1.10.up$idpicc==759,]$mdsupdrspart3bltotalconvertedasa<-37.19017
data1.10.up[data1.10.up$idpicc==822,]$mdsupdrspart3bltotalconvertedasa<-64.63385
data1.10.up[data1.10.up$idpicc==830,]$mdsupdrspart3bltotalconvertedasa<-28.18615
data1.10.up[data1.10.up$idpicc==831,]$mdsupdrspart3bltotalconvertedasa<-28.70094
data1.10.up[data1.10.up$idpicc==1246,]$mdsupdrspart3bltotalconvertedasa<-50.15601	

#Missing years of education idpicc 10 48 90 111 324 329 350 384 1116 1118 1121 1143

#imp3.new%>%
#  filter(Imputation==2)%>%
#  filter(idpicc==329)%>%
#  select(yearseducation)

data1.10.up[data1.10.up$idpicc==10,]$yearseducation<-8.825283	
data1.10.up[data1.10.up$idpicc==48,]$yearseducation<-8.231928
data1.10.up[data1.10.up$idpicc==90,]$yearseducation<-11.89748		
data1.10.up[data1.10.up$idpicc==111,]$yearseducation<-10.35272		
data1.10.up[data1.10.up$idpicc==324,]$yearseducation<-13.94519	
data1.10.up[data1.10.up$idpicc==329,]$yearseducation<-19.00656	
data1.10.up[data1.10.up$idpicc==350,]$yearseducation<-6.584745	
data1.10.up[data1.10.up$idpicc==384,]$yearseducation<-9.084082		
data1.10.up[data1.10.up$idpicc==1116,]$yearseducation<-9.227734		
data1.10.up[data1.10.up$idpicc==1118,]$yearseducation<-11.02249			
data1.10.up[data1.10.up$idpicc==1121,]$yearseducation<-14.41573	
data1.10.up[data1.10.up$idpicc==1143,]$yearseducation<-5.652798		

#Missing smoking idpicc 637 662 680 683 686 717 737 810 847 

#imp3.new%>%
#  filter(Imputation==2)%>%
#  filter(idpicc==847)%>%
#  select(smoking)

#class(imp3.new$smoking)

data1.10.up[data1.10.up$idpicc==637,]$smoking<-"no"
data1.10.up[data1.10.up$idpicc==662,]$smoking<-"no"
data1.10.up[data1.10.up$idpicc==680,]$smoking<-"no"
data1.10.up[data1.10.up$idpicc==683,]$smoking<-"no"
data1.10.up[data1.10.up$idpicc==686,]$smoking<-"no"
data1.10.up[data1.10.up$idpicc==717,]$smoking<-"no"
data1.10.up[data1.10.up$idpicc==737,]$smoking<-"yes"
data1.10.up[data1.10.up$idpicc==810,]$smoking<-"no"
data1.10.up[data1.10.up$idpicc==847,]$smoking<-"no"


```


```{r change long format data}

#Now we have completed baseline variable in data1.10.up

#-----create follow-up times in years----


data1.10.up$year0<-0

data1.10.up$year1<-as.Date(as.character(data1.10.up$datevisityr1), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year1<-as.numeric(data1.10.up$year1)/365.25

data1.10.up$year2<-as.Date(as.character(data1.10.up$datevisityr2), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year2<-as.numeric(data1.10.up$year2)/365.25

data1.10.up$year3<-as.Date(as.character(data1.10.up$datevisityr3), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year3<-as.numeric(data1.10.up$year3)/365.25

data1.10.up$year4<-as.Date(as.character(data1.10.up$datevisityr4), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year4<-as.numeric(data1.10.up$year4)/365.25

data1.10.up$year5<-as.Date(as.character(data1.10.up$datevisityr5), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year5<-as.numeric(data1.10.up$year5)/365.25

data1.10.up$year6<-as.Date(as.character(data1.10.up$datevisityr6), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year6<-as.numeric(data1.10.up$year6)/365.25

data1.10.up$year7<-as.Date(as.character(data1.10.up$datevisityr7), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year7<-as.numeric(data1.10.up$year7)/365.25

data1.10.up$year8<-as.Date(as.character(data1.10.up$datevisityr8), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year8<-as.numeric(data1.10.up$year8)/365.25

data1.10.up$year9<-as.Date(as.character(data1.10.up$datevisityr9), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year9<-as.numeric(data1.10.up$year9)/365.25

data1.10.up$year10<-as.Date(as.character(data1.10.up$datevisityr10), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year10<-as.numeric(data1.10.up$year10)/365.25

data1.10.up$year11<-as.Date(as.character(data1.10.up$datevisityr11), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year11<-as.numeric(data1.10.up$year11)/365.25

data1.10.up$year12<-as.Date(as.character(data1.10.up$datevisityr12), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year12<-as.numeric(data1.10.up$year12)/365.25

data1.10.up$year13<-as.Date(as.character(data1.10.up$datevisityr13), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year13<-as.numeric(data1.10.up$year13)/365.25

data1.10.up$year14<-as.Date(as.character(data1.10.up$datevisityr14), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year14<-as.numeric(data1.10.up$year14)/365.25

data1.10.up$year15<-as.Date(as.character(data1.10.up$datevisityr15), format="%Y-%m-%d")-
                as.Date(as.character(data1.10.up$datevisitbl), format="%Y-%m-%d")
data1.10.up$year15<-as.numeric(data1.10.up$year15)/365.25


#----create year follow-up----

# Perform pivot_longer operation
years_long.up <- data1.10.up %>%
    pivot_longer(
      cols = c(`year0`:`year15`),
      names_to = "visityear",
      values_to = "followupyears",
      values_transform = ~ as.numeric(gsub(",", "", .x)),
      values_drop_na = TRUE
    )
  
years_long.up%>%
  select(study,idpicc,visityear,followupyears)


#----create MMSE follow-up----

# Select specific columns

MMSE_data.up <- data1.10.up %>%
    select("study", "idpicc", "originalid", "mmsebltotal",
           "mmseyr1total", "mmseyr2total", "mmseyr3total", "mmseyr4total",
           "mmseyr5total", "mmseyr6total", "mmseyr7total", "mmseyr8total",
           "mmseyr9total", "mmseyr10total", "mmseyr11total", "mmseyr12total")
  
# Rename selected columns

colnames(MMSE_data.up)[4:16] <- c("year0","year1", "year2", "year3", "year4",
                                 "year5", "year6", "year7", "year8",
                                 "year9", "year10", "year11", "year12")
  
# Perform pivot_longer operation
  mmse_long.up <- MMSE_data.up %>%
    pivot_longer(
      cols = `year0`:`year12`,
      names_to = "visityear",
      values_to = "mmse",
      values_transform = ~ as.numeric(gsub(",", "", .x)),
      values_drop_na = TRUE
    )
  

#----create cognitive symptoms follow-up----

cogni_data.up<-data1.10.up%>%
    select("study", "idpicc", "originalid","cognitivebl","cognitiveyr1","cognitiveyr2",
           "cognitiveyr3","cognitiveyr4","cognitiveyr5","cognitiveyr6","cognitiveyr7",
           "cognitiveyr8","cognitiveyr9","cognitiveyr10","cognitiveyr11")
  
# Rename selected columns

colnames(cogni_data.up)[4:15] <- c("year0","year1", "year2", "year3", "year4",
                                 "year5", "year6", "year7", "year8",
                                 "year9", "year10", "year11")
  
# Perform pivot_longer operation
  cogni_long.up <- cogni_data.up %>%
    pivot_longer(
      cols = `year0`:`year11`,
      names_to = "visityear",
      values_to = "cognitive",
      values_transform = ~ as.factor(gsub(",", "", .x)), #As it is factor, use as.factor
      values_drop_na = TRUE
    )

  
class(cogni_long.up$cognitive)


#----create hallucination follow-up----

hallucina_data.up<-data1.10.up%>%
    select("study", "idpicc", "originalid","hallucinationsbl","hallucinationsyr1","hallucinationsyr2",
           "hallucinationsyr3","hallucinationsyr4","hallucinationsyr5","hallucinationsyr6",
           "hallucinationsyr7","hallucinationsyr8","hallucinationsyr9","hallucinationsyr10","hallucinationsyr11")

# Rename selected columns

colnames(hallucina_data.up)[4:15] <- c("year0","year1", "year2", "year3", "year4",
                                 "year5", "year6", "year7", "year8",
                                 "year9", "year10", "year11")
  
# Perform pivot_longer operation
  hallucina_long.up <- hallucina_data.up %>%
    pivot_longer(
      cols = `year0`:`year11`,
      names_to = "visityear",
      values_to = "hallucination",
      values_transform = ~ as.factor(gsub(",", "", .x)), #As it is factor, use as.factor
      values_drop_na = TRUE
    )

class(hallucina_long.up$hallucination)
  
```

```{r combine long format}
nrow(years_long.up)  #5317
nrow(mmse_long.up)   #4618
nrow(cogni_long.up)  #5179
nrow(hallucina_long.up) #5187

years_long.up.new<-years_long.up%>%
  select("study","idpicc","originalid",
         "agebl","sex","hybl",
         "smoking","yearseducation","mdsupdrspart3bltotalconvertedasa",
         "cens","years","followupyears","visityear")


mmse_long.up.new<-mmse_long.up%>%
  select("study","idpicc","visityear","mmse")

data_long.up.1<-merge(years_long.up.new, mmse_long.up.new, by = c("study","idpicc","visityear"),all.x = T,all.y = T)

data_long.up.1<-data_long.up.1[order(data_long.up.1$id,data_long.up.1$visityear), ]

cogni_long.up.new<-cogni_long.up%>%
  select("study","idpicc","visityear","cognitive")

data_long.up.2<-merge(data_long.up.1,cogni_long.up.new, by= c("study","idpicc","visityear"),all.x = T,all.y = T)

data_long.up.2<-data_long.up.2[order(data_long.up.2$id,data_long.up.2$visityear), ]


hallucina_long.up.new<-hallucina_long.up%>%
  select("study","idpicc","visityear","hallucination")

data_long.up.3<-merge(data_long.up.2,hallucina_long.up.new, by= c("study","idpicc","visityear"),all.x = T,all.y = T)

data_long.up.3<-data_long.up.3[order(data_long.up.3$id,data_long.up.3$visityear), ]

```

```{r check missing data in long data}
#----check age----

data_long.up.3%>%
  group_by(study)%>%
  count(is.na(agebl))

#idpicc 1170 1235 1261 

#1170 The follow-up time is end in 10 years,patient has mmse value on 11 and 12 years. 
#1261 The follow-up time is end in 9 years, patient has mmse value on 10 and 11 years.

#remove value outside the last seen date

data_long.up.3<-data_long.up.3[!is.na(data_long.up.3$agebl), ]

#check sex

data_long.up.3%>%
  group_by(study)%>%
  count(is.na(sex))

```

```{r remove data after event}

#All follow-up records after event need to be removed

data_long.up.3.new<-data_long.up.3%>%
                  filter(years>followupyears)

```

```{r create baseline data}

data.baseline.up<-data1.10.up%>%
  select("study","idpicc","originalid","agebl","sex","hybl","mdsupdrspart3bltotalconvertedasa","yearseducation","smoking","cens","years")

levels(data_long.up.3.new$study)
levels(data.baseline.up$study)

setdiff(unique(data.baseline.up$idpicc),unique(data_long.up.3.new$idpicc)) #No different between this two study
```

```{r pre data for fit model}

data_long.fit.up<-data_long.up.3.new[complete.cases(data_long.up.3.new),]
  
data.baseline.fit.up<-data.baseline.up

diff_idpicc.up<-setdiff(unique(data.baseline.fit.up$idpicc),unique(data_long.fit.up$idpicc))

#idpicc 328 331 354 436 832 1169 1208 1271

data1.10.up%>%
  filter(idpicc %in% diff_idpicc.up)%>%
  group_by(study)%>%
  count()

#4 in NYPUM no MMSE at all 
#1 in PICNICS ?
#3 in PINE ?

data1.10.up%>%
  filter(idpicc %in% diff_idpicc.up)%>%
  group_by(study)

```

```{r linear mixed models}

#---For MMSE----

lme<-lme(mmse~ study+agebl+sex+yearseducation, random = ~ followupyears | idpicc, data=data_long.fit.up)


#---For cognitive symptom----



#-----For hallucination----

```
