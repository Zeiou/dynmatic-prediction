---
title: "Dementia pre 1"
output: html_document
date: "2023-05-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
library(dplyr)
library(tidyr)
library(Hmisc)
library(finalfit)
library(jomo)
library(mice)
library(mitools)
library(rms)
library(mitml)
library(survminer)
library(patchwork) #Arrange plot
library(ggplot2)
library(GGally)
library(gridExtra)
library(png)
library(grid)
library(haven) #read_dta
library(nlme)
library("JMbayes2")
```

```{r data}
data<-read_dta("PICC dynamic prediction v3.dta")

write.csv(data,"data.csv",row.names = F)  # need to be csv file, otherwise it fails
datanew<-read.csv("data.csv")  #import data again

#Update data: PCP66 is a male, baseline age is 74.8

datanew$sex[datanew$originalid=="PCP66"]<-0  #male is 0
datanew$agebl[datanew$originalid=="PCP66"]<-74.8

#update P150 H&Y year2 is 2 not 0
#update P757 H&Y year1 is 1.5 not 0

datanew$hyyr2[datanew$originalid=="P150"]<-2
datanew$hyyr1[datanew$originalid=="P757"]<-1.5

#UPDATE P195 need to be exclude cos patient decline the follow-up and without the visit date only mmse value in medical record

datanew<-datanew%>%
  filter(originalid!="P195")

datanew[datanew$originalid=="PCP46",]
```

```{r select variables need}

#Baseline age, sex, years of education, presence of hallucinations, cognitive symptoms (none, vs yes but not impairing functioning, vs yes and impairing functioning), ? H&Y stage, MDS-UPDRS part 3, (MMSE).



data1<-datanew%>%
  select("study","idpicc","originalid","incidencecase","agebl","sex","hybl",
         "smoking",
         "mdsupdrspart3bltotalconvertedasa",
         "mdsupdrsbl102hallucinations", "updrsblitem2thoughtdisorders",
         "mdsupdrsbl101cognitive","updrsblitem1intellectual",
         "mmsebltotal","mmseyr1total","mmseyr2total","mmseyr3total","mmseyr4total","mmseyr4total","mmseyr5total","mmseyr6total","mmseyr7total","mmseyr8total","mmseyr9total","mmseyr10total","mmseyr11total","mmseyr11total","mmseyr12total","datevisitbl","datevisityr1","datevisityr2","datevisityr3","datevisityr4","datevisityr5","datevisityr6","datevisityr7","datevisityr8","datevisityr9","datevisityr10","datevisityr11","datevisityr12","datevisityr13","datevisityr14","datevisityr15","datelastseen","datelastknownalive","datedeath","datedementia","datelost")

data1$study<-factor(data1$study,
                    levels = c(1,2,3,4,5,6),
                    labels= c("CamPalGN","ICICLE","NYPUM","ParkWest","PICNICS","PINE"))


#daily levodopa equivalent dose in ParkWest were all zero in baseline

#----change into factor---

data1$sex<-factor(data1$sex,
                    levels = c(0,1),
                    labels= c("male","female"))


#UPDATE PCP46 and PCP66 both male

data1[data1$originalid=="PCP46",]$sex<-"male"
data1[data1$originalid=="PCP46",]$idpicc<-1692
data1[data1$originalid=="PCP66",]$sex<-"male"
data1[data1$originalid=="PCP66",]$idpicc<-1693


data1$smoking<-factor(data1$smoking,
                    levels = c(1,2,3),
                    labels= c("current smoker","ex smoker","never smoker"))


#------Create index for hallucinations------

data1$updrshallucinations<-ifelse(data1$mdsupdrsbl102hallucinations>0,1,0)  # 1=yes,0=no

data1$updrsthoughtdisorders<-ifelse(data1$updrsblitem2thoughtdisorders>1,1,0)  # 1=yes (2-4),0=no (0-1)

data1<-data1 %>%
      mutate(hallucinationsindex=updrshallucinations)%>%           
      mutate(hallucinationsindex=coalesce(hallucinationsindex,updrsthoughtdisorders)) #if updrshallucinations not find then use updrsthoughtdisorders

data1$hallucinationsindex<-factor(data1$hallucinationsindex,
                                  levels = c(0,1),
                                  labels = c ("no","yes"))



#-----Create index for cognitive---------

#Cognitive symptoms as measured by UPDRS item 1 (intellectual impairment)/MDS-UPDRS item 1 (cognitive impairment), categorized as 0 (no cognitive symptoms), 1 (cognitive symptoms, not impairing functioning), 2+ (cognitive symptoms impairing functioning).

data1$mdsupdrsbl101cognitive[data1$mdsupdrsbl101cognitive>1]<-2
data1$updrsblitem1intellectual[data1$updrsblitem1intellectual>1]<-2

data1<-data1 %>%
      mutate(cognitiveindex=mdsupdrsbl101cognitive)%>%           
      mutate(cognitiveindex=coalesce(cognitiveindex,updrsblitem1intellectual)) 


#0 is no cognitive symptoms, 1 is cognitive symptoms, not impairing functioning, 2 is cognitive symptoms impairing functioning


data1$cognitiveindex<-factor(data1$cognitiveindex,
                             levels = c(0,1,2),
                             labels = c("no cognitive symptoms", "cognitive symptoms but not impairing functioning","cognitive symptoms impairing functioning"))



table(data1$study,data1$hallucinationsindex)
table(data1$study,data1$cognitiveindex)

#ICICLE missing all 

#If to include those two predictors, we need to exclude ICICLE
```


```{r cens events}

#-----create events/censoring years------

data1<-data1 %>%
  mutate(t=datedementia)%>%           
  mutate(t=coalesce(t,datelastknownalive))%>%
  mutate(t=coalesce(t,datelastseen))

#if patients have the date of death then t is the date of dementia. If patients without date of dementia, then the censoring date will be the date of last know alive. If patients without the date of last know alive then the censoring date will be the date last seen. Because I found some patients with date of lost is much later than the last seen, but the measurement stop in the last seen visiting year.


#sum(is.na(data2$t)) # 0 missing



data1$cens<-ifelse(is.na(data1$datedementia),0,1)  #0=right censored, 1=event 

data1$tt<-as.Date(as.character(data1$t), format="%Y-%m-%d")-
                as.Date(as.character(data1$datevisitbl), format="%Y-%m-%d")

data1$tt<-as.numeric(data1$tt)

data1$years<-data1$tt/365.25  #1222 rows

data1%>%
  filter(tt==0)%>%
  group_by(study)%>%
  count()            #CamPalGN 21 ICICLE 3 NYPUM 8 ParkWest 4 PICNICS 29 PINE 14 


data1%>%
  filter(tt<0)%>%
  group_by(study)%>%
  count()          #PINE 62, already has dementia before baseline visit

data1<-data1%>%
  filter(data1$years>0) #1080 removed 142 patients 

data1%>%
  group_by(study)%>%
  count()


data1%>%
  group_by(study)%>%
  summarise(sum(cens))
```


```{r only keep those have mmse follow-up}

data.nommse.follow<-data1%>%
  filter(is.na(mmseyr1total)&is.na(mmseyr2total)&is.na(mmseyr3total)&is.na(mmseyr4total)&is.na(mmseyr5total)&is.na(mmseyr6total)&is.na(mmseyr7total)&is.na(mmseyr8total)&is.na(mmseyr9total)&is.na(mmseyr10total)&is.na(mmseyr11total)&is.na(mmseyr12total))

data.nommse.follow%>%
  group_by(study)%>%
  count()

#ICICLE 14, NYPUM 6, ParkWest 3, PICNICS 19, PINE 5 (P158,P529,P579,P794,P85)
#47 patients didn't have mmse follow-up 

data1<-data1%>%
  filter(!is.na(mmseyr1total)|!is.na(mmseyr2total)|!is.na(mmseyr3total)|!is.na(mmseyr4total)|!is.na(mmseyr5total)|!is.na(mmseyr6total)|!is.na(mmseyr7total)|!is.na(mmseyr8total)|!is.na(mmseyr9total)|!is.na(mmseyr10total)|!is.na(mmseyr11total)|!is.na(mmseyr12total))


```


```{r up to 10 years}


#only 57 over 10 years

data1.temp10<-survSplit(Surv(years, cens) ~ ., data = data1, cut = 10,
                  episode="timegroup")


data1.10.all<-subset(data1.temp10, timegroup == 1) #only the first 10 year

#---No need for ICICLE----

data1.10<-data1.10.all%>%
  filter(study!="ICICLE")
```


```{r impute baseline data}
#impute data first before it change to longitudinal data

data.rename.noIC<-data1.10%>%
  rename("Age at baseline"=agebl, 
         "Sex"=sex,
         "MDS-UPDRS part3"=mdsupdrspart3bltotalconvertedasa,"Hoehn and Yahr Scale"=hybl, "Smoking"=smoking,
         "Hallucinations"=hallucinationsindex,"Cognitive symptoms"= cognitiveindex
         ) #

explanatory<-c("Smoking","MDS-UPDRS part3","Hoehn and Yahr Scale","Hallucinations","Cognitive symptoms") 
dependent<- c("cens","tt") #"Smoking"

mispattern<-data.rename.noIC %>% 
  missing_pattern(explanatory)

#---check how many missing at least one---

colnames(data1.10)

nrow(data1.10[complete.cases(data1.10[,c(8,9,50,51)]),])  #825

(896-825)/896
```

```{r impute baseline data}

#-----EXCLUDE ICICLE----

data1.10$cons<-1

data1.10$nelsonaalen<-nelsonaalen(data1.10,years,cens) #0 is right censor,1 is event

Y<- data1.10[,c("mdsupdrspart3bltotalconvertedasa","hallucinationsindex","cognitiveindex","smoking")]  


X<-data1.10[,c("cons","agebl","sex","hybl","nelsonaalen")] #adding Nelson-Aalen estimate  

clus<-data1.10$study

imp.dry<-jomo.MCMCchain(Y = Y,X = X,clus = clus, nburn = 2)

set.seed(15678)
imp1 <- jomo.MCMCchain(Y = Y, X = X, clus = clus, nburn = 5000)


#head(imp1$collectbeta) # check beta

#plot trace for each parameter value

#png("Jomo1.png",width = 3500,height =2000,res = 400)

#par(mfrow=c(2,4))

plot(imp1$collectbeta[1, 1, 1:5000], type = "l", ylab = expression(beta["mdsupdrspart3,0"]),
     xlab = "Iteration number" )

plot(imp1$collectbeta[1, 2, 1:5000], type = "l", ylab = expression(beta["hallucinationsindex.1 ,0"]),
     xlab = "Iteration number" )

plot(imp1$collectbeta[1, 3, 1:5000], type = "l", ylab = expression(beta["cognitiveindex.1,0"]),
     xlab = "Iteration number" ) 

plot(imp1$collectbeta[1, 4, 1:5000], type = "l", ylab = expression(beta["cognitiveindex.2,0"]),
     xlab = "Iteration number" ) 

plot(imp1$collectbeta[1, 5, 1:5000], type = "l", ylab = expression(beta["smoking.1,0"]),
     xlab = "Iteration number" ) 

plot(imp1$collectbeta[1, 6, 1:5000], type = "l", ylab = expression(beta["smoking.2,0"]),
     xlab = "Iteration number" ) 

#plot trace for cov matrix element
#imp1$collectomega[,,1] #check the row and col name
#Category variable don't need to plot, just a straight line

plot(imp1$collectomega[1, 1, 1:5000], type = "l", ylab = expression(omega[MDS-UPDRS,1,1]^2),
     xlab = "Iteration number" )


#dev.off()


# Capture the state of the sampler as starting values for the second set of iterations:
beta.start <- imp1$collectbeta[,,5000] # capture the fixed parameter values
l1cov.start <- imp1$collectomega[,,5000] # capture the level-1 covariance matrix values
start.imp <- imp1$finimp.latnorm # capture the final imputed data set 



#Re-run the same function for a larger number of iterations
imp2 <- jomo.MCMCchain(Y = Y, X = X, clus = clus, beta.start = beta.start, l1cov.start = l1cov.start,
                       start.imp = start.imp, nburn = 5000)

# Check the trace again

#png("Jomo2.png",width = 3500,height =2000,res = 400)

#par(mfrow=c(2,4))

plot(imp2$collectbeta[1, 1, 1:5000], type = "l", ylab = expression(beta["mdsupdrspart3,0"]),
     xlab = "Iteration number" )

plot(imp2$collectbeta[1, 2, 1:5000], type = "l", ylab = expression(beta["hallucinationsindex.1,0"]),
     xlab = "Iteration number" ) 

plot(imp2$collectbeta[1, 3, 1:5000], type = "l", ylab = expression(beta["cognitiveindex.1,0"]),
     xlab = "Iteration number" ) 

plot(imp2$collectbeta[1, 4, 1:5000], type = "l", ylab = expression(beta["cognitiveindex.2,0"]),
     xlab = "Iteration number" ) 

plot(imp2$collectbeta[1, 5, 1:5000], type = "l", ylab = expression(beta["smoking.1,0"]),
     xlab = "Iteration number" ) 

plot(imp2$collectbeta[1, 6, 1:5000], type = "l", ylab = expression(beta["smoking.2,0"]),
     xlab = "Iteration number" ) 

#plot trace for cov matrix element

plot(imp2$collectomega[1, 1, 1:5000], type = "l", ylab = expression(omega[mdsupdrspart3,1,1]^2),
     xlab = "Iteration number" )



#dev.off()

#collect posterior mean of cov matrix
l1cov.guess <- apply(imp2$collectomega, c(1, 2), mean)

dim(imp2$collectomega[,,1]) #degrees of freedom is 6

# Multiply by degrees of freedom to get scale matrix

l1cov.prior <- l1cov.guess*6

# Perform multilevel imputation:
imp3 <- jomo(Y = Y, X = X, clus = clus, l1cov.prior = l1cov.prior, nburn = 5000, nbetween = 1000, nimp = 8,meth = "random" )  #The nimp is the precentage of missing 


```

```{r merge data baseline}

names(imp3)
dim(imp3)
#View original (partially observed) data:
head(imp3)
# View last imputation (the left most column is the row number):
head(imp3[imp3$Imputation == 1,])

#create id to merge the data 

data1.10$id<-seq(nrow(data1.10)) 

data1.10.mmse<-data1.10%>%
  select("id","study","idpicc","originalid",
         "mmsebltotal","mmseyr1total","mmseyr2total","mmseyr3total","mmseyr4total","mmseyr4total","mmseyr5total","mmseyr6total","mmseyr7total","mmseyr8total","mmseyr9total","mmseyr10total","mmseyr11total","mmseyr11total","mmseyr12total","datevisitbl","datevisityr1","datevisityr2","datevisityr3","datevisityr4","datevisityr5","datevisityr6","datevisityr7","datevisityr8","datevisityr9","datevisityr10","datevisityr11","datevisityr12","datevisityr13","datevisityr14","datevisityr15","cens","tt","years")

imp3.new<-merge(imp3,data1.10.mmse,by.x = "id",by.y = "id")

```


```{r check the imputation set}

imp3.new[imp3.new$mdsupdrspart3bltotalconvertedasa<0,]#only one negative patients idpicc 633

imp3.new$mdsupdrspart3bltotalconvertedasa[imp3.new$idpicc==633 & imp3.new$Imputation==6]<-0

imp3.new$age10<-imp3.new$agebl/10

imp3.new$mdsupdrs3.10<-imp3.new$mdsupdrspart3bltotalconvertedasa/10

summary(imp3.new$mdsupdrspart3bltotalconvertedasa)

data.imp<-imputationList(split(imp3.new, imp3.new$Imputation)[-1])
```

```{r extract 8 imputed dataset}
 
#There will be need to create 8 different imputation in baseline and longitudinal

data.imp.new_names <- paste("data.imp",1:8,sep="")  # create names first

imp.list<-data.imp[["imputations"]]

# Loop through the indices of the list
for (i in 1:8) {
  # Extract the dataset based on the index
  extracted_dataset <- imp.list[[i]]
  
  # Assign the extracted dataset to the corresponding variable
  assign(paste0("data.imp", i), extracted_dataset)
}

```


```{r change long format (longitudinal) for data.imp1}

#-----create follow-up times in years----

# Define the variable names
year_names <- paste0("year", 1:15)

# Convert year columns and baseline visit year to numeric
data.imp1[, paste0("datevisityr", 1:15)] <- lapply(data.imp1[, paste0("datevisityr", 1:15)], as.Date,format="%Y-%m-%d")
data.imp1$datevisitbl <- as.Date(data.imp1$datevisitbl,format="%Y-%m-%d")

# Create new variables using a loop
for (i in 1:15) {
  # Calculate the difference between the year and baseline visit year
  year <- as.numeric(data.imp1[[paste0("datevisityr", i)]] - data.imp1$datevisitbl)/365.25
  
  # Assign the calculated values to a new variable
  
  data.imp1[[year_names[i]]] <- year
}

#head(data.imp1)
#colnames(data.imp1)
#colnames(data.imp1[,c(1:30,46:65)])

data.imp1<-data.imp1[,c(1:30,46:65)]

#----create year follow-up----

years_long.1<-data.imp1%>%
  pivot_longer(
    cols = `year1`:`year15`,
    names_to = "visityear",
    values_to = "followupyears",
    values_transform = ~ as.numeric(gsub(",", "", .x)),
    values_drop_na = T
  )



#change mmseyr to year1 


MMSE_data.1<-data.imp1%>%
  select("id","clus","idpicc","originalid","study","mmsebltotal","mmseyr1total","mmseyr2total","mmseyr3total","mmseyr4total","mmseyr4total","mmseyr5total","mmseyr6total","mmseyr7total","mmseyr8total","mmseyr9total","mmseyr10total","mmseyr11total","mmseyr11total","mmseyr12total")

colnames(MMSE_data.1)[7:18]<-c("year1","year2","year3","year4",
                          "year5","year6","year7","year8",
                          "year9","year10","year11","year12")

mmse_long.1<-MMSE_data.1%>%
  pivot_longer(
    cols = `year1`:`year12`,
    names_to = "visityear",
    values_to = "mmse",
    values_transform = ~ as.numeric(gsub(",", "", .x)),
    values_drop_na = T
  )


```

```{r cmobine long format dataset 1}
#-----combine all long tidy------

nrow(years_long.1)  #4564
nrow(mmse_long.1)   #3905


years_long.new.1<-years_long.1%>%
  select("id","study","idpicc","originalid",
         "agebl","sex","hybl",
         "smoking",
         "mdsupdrspart3bltotalconvertedasa",
         "hallucinationsindex",
         "cognitiveindex",
         "cens","years","followupyears","visityear")


mmse_long.new.1<-mmse_long.1%>%
  select("id","study","idpicc","visityear","mmse")

data_long.1<-merge(years_long.new.1, mmse_long.new.1, by = c("id","study","idpicc","visityear"),all.x = T,all.y = T)

data_long.1<-data_long.1[order(data_long.1$id,data_long.1$visityear), ]

```

```{r check missing age in longtitude datasets}

#----check age----

data_long.1%>%
  group_by(study)%>%
  count(is.na(agebl))
#6 patints in PINE missing agebl

data_long.1%>%
  filter(study=="PINE")%>%
  filter(is.na(agebl))
#idpicc 1170 1235 1261 

#1170 The follow-up time is end in 10 years,patient has mmse value on 11 and 12 years. 
#1235 The follow-up time is end in 9 years, patient has mmse value on 10 and 11 years.
#1261 The follow-up time is end in 9 years, patient has mmse value on 10 and 11 years.

#------remove value outside the last seen date-----

#Due to the data just medical records not real follow-up we remove it

data_long.1<-data_long.1[!is.na(data_long.1$agebl),]

#----check sex----

data_long.1%>%
  group_by(study)%>%
  count(is.na(sex))

```


```{r create longitudinal data1}

#data_long.1[complete.cases(data_long.1),]

data_long.1<-data_long.1[!is.na(data_long.1$mmse),]


#unique(data_long.1$id) 896 same as nrow(data.baseline)

data_long.1<-data_long.1[data_long.1$years!=data_long.1$followupyears,]

```

```{r create baseline data}

data.baseline.1<-data.imp1%>%
  select("id","study","idpicc","originalid","agebl","sex","hybl","mdsupdrspart3bltotalconvertedasa","smoking","hallucinationsindex","cognitiveindex","cens","tt","years")

data.baseline.1$age10<-data.baseline.1$agebl/10

data.baseline.1$mdsupdrs3.10<-data.baseline.1$mdsupdrspart3bltotalconvertedasa/10
```

```{r match longtidue data with baseline}

#If patients only had one follow-up, which mean the follow-up equal to the event year, then need to be removed. 

setdiff(unique(data.baseline.1$id),unique(data_long.1$id)) #65 182 351 689 737 839

data.baseline.1<-data.baseline.1[data.baseline.1$id!=65,]
data.baseline.1<-data.baseline.1[data.baseline.1$id!=182,]
data.baseline.1<-data.baseline.1[data.baseline.1$id!=351,]
data.baseline.1<-data.baseline.1[data.baseline.1$id!=689,]
data.baseline.1<-data.baseline.1[data.baseline.1$id!=737,]
data.baseline.1<-data.baseline.1[data.baseline.1$id!=839,]

```


```{r check longitudinal outcome mmse}

data_plot<-data_long.1[order(data_long.1$followupyears), ]

mmse_plot<-data_plot%>%
   select("study","id","idpicc","followupyears","visityear","mmse")

mmse_plot<-mmse_plot%>%
  arrange(id,followupyears)


ggplot(data = mmse_plot, aes(x = followupyears, y = mmse,group=id))+
    geom_line()

#check the one with all zero MMSE in followup years

mmse_plot%>%
  filter(mmse==0)

#1666
#1677
#1300

mmse_plot%>%
  filter(idpicc==1666) # 0 0

mmse_plot%>%
  filter(idpicc==1677) # 19 18 10 0 0

mmse_plot%>%
  filter(idpicc==1300) # 29 28 26 25 16 13 0 0 0

ggplot(data = subset(mmse_plot,study=="CamPalGN"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()

ggplot(data = subset(mmse_plot,study=="ParkWest"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()

ggplot(data = subset(mmse_plot,study=="PICNICS"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()

ggplot(data = subset(mmse_plot,study=="NYPUM"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()

ggplot(data = subset(mmse_plot,study=="PINE"), aes(x = followupyears, y = mmse,group=idpicc))+
    geom_line()

```


```{r all study model}

#Because joint model is independent individual, so I don't think it need to strata.

baseline.cox<-coxph(Surv(years,cens)~age10+sex+mdsupdrs3.10+hybl+hallucinationsindex+cognitiveindex,data=data.baseline.1, x = TRUE,model = TRUE)

lmeFit<- lme(mmse~ followupyears, random = ~ followupyears | idpicc, data = data_long.1)

jointFit<-jm(baseline.cox, lmeFit, time_var = "followupyears")

summary(jointFit)

```

```{r Note for next step}

# Need to find a Linear mixed model to fit MMSE

#Need to create another 7 dataset and rerun the model for 7 times. 

#This file should be the file to create 8 datasets. 

#Re run the imputation, to see if the cogntive index is yes and no will that be better?

#Put the model in the next file. 

#Need to think about how to do the rubin's rule.

```